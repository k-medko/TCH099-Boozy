<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cr√©er une commande</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #34495e;
      --primary-hover: #2c3e50;
      --gray-light: #f4f6f8;
      --gray-dark: #2c3e50;
      --white: #ffffff;
      --gray-border: #d0d7de;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body, html {
      font-family: 'Poppins', sans-serif;
      background-color: var(--gray-light);
      height: 100%;
    }
    .wrapper { display:flex; flex-direction:column; min-height:100vh; }
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:16px 24px; background:var(--white);
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    .logo-container { display:flex; align-items:center; gap:12px; margin-left:40px; }
    header h1 {
      font-size:24px; font-weight:600; color:var(--gray-dark);
      display:flex; align-items:center; gap:12px;
    }
    header h1 img { height:36px; border-radius:8px; }
    .header-controls { display:flex; align-items:center; gap:10px; }
    .search-bar {
      display:flex; align-items:center; background:var(--white);
      border:1px solid var(--gray-border); border-radius:999px;
      padding:4px 8px; box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    .search-bar input {
      border:none; outline:none; padding:6px 12px;
      font-size:14px; border-radius:999px; width:160px;
    }
    .search-bar button {
      background:var(--primary); color:#fff; border:none;
      padding:6px 14px; border-radius:999px; cursor:pointer;
      font-weight:500; transition:0.3s;
    }
    .search-bar button:hover {
      background:#fff; color:var(--primary); border:1px solid var(--primary);
    }
    .lang-btn, .logout {
      font-size:14px; padding:8px 12px; border-radius:6px;
      cursor:pointer; font-weight:500;
    }
    .lang-btn {
      background:transparent; border:1.5px solid var(--gray-dark);
      color:var(--gray-dark);
    }
    .lang-btn:hover { background:var(--gray-dark); color:#fff; }
    .logout {
      background:var(--primary); color:#fff; border:none;
    }
    .logout:hover { background:var(--primary-hover); }

    .main { display:flex; flex-grow:1; }
    .sidebar-overlay {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.5); z-index:98; display:none;
    }
    .sidebar-overlay.show { display:block; }
    .sidebar-toggle {
      position:fixed; top:28px; left:16px; z-index:99;
      background:var(--primary); color:#fff; border:none;
      border-radius:6px; padding:8px 12px; cursor:pointer;
    }
    nav {
      width:300px; max-width:80%; background:var(--white);
      position:fixed; top:0; left:-100%; height:100vh;
      padding:40px 24px; display:flex; flex-direction:column; gap:28px;
      z-index:100; box-shadow:4px 0 12px rgba(0,0,0,0.2);
      transition:left 0.3s ease;
    }
    nav.show { left:0; }
    nav a {
      display:flex; align-items:center; gap:14px;
      padding:14px 20px; font-size:16px; color:var(--gray-dark);
      text-decoration:none; border-radius:12px; transition:all 0.3s;
      font-weight:500;
    }
    nav a:hover, nav a.active { background:var(--gray-light); }
    nav a img { width:20px; height:20px; }

    .content {
      flex:1; padding:24px;
      display:flex; justify-content:center; align-items:flex-start;
    }
    .form-container {
      background:var(--white); padding:24px;
      border-radius:16px; box-shadow:0 6px 12px rgba(0,0,0,0.05);
      width:100%; max-width:480px;
    }
    .form-container h1 {
      font-size:20px; margin-bottom:16px; color:var(--gray-dark);
    }
    .form-container label {
      display:block; margin-top:12px; font-weight:500;
    }
    .form-container input,
    .form-container select {
      width:100%; padding:8px 10px; margin-top:6px;
      border:1px solid var(--gray-border); border-radius:6px;
      font-size:14px;
    }
    .form-container button {
      margin-top:16px; background:var(--primary);
      color:#fff; border:none; padding:10px 16px;
      border-radius:6px; cursor:pointer; font-weight:600;
      transition:background 0.3s;
    }
    .form-container button:hover {
      background:var(--primary-hover);
    }

    .items-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-top:16px;
    }
    .item-row {
      display:flex; gap:8px; align-items:center; margin-top:8px;
    }
    .item-row select,
    .item-row input {
      flex:1; padding:6px 8px;
    }
    .remove-btn {
      background:#dc2626; color:#fff; border:none;
      padding:6px 10px; border-radius:6px; cursor:pointer;
    }
    .remove-btn:hover { opacity:0.8; }

    footer {
      background:var(--primary); color:#fff;
      height:90px; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      font-size:14px; padding:10px; text-align:center;
    }
    footer a { color:#ffc0cb; text-decoration:none; }
    footer a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <header>
      <div class="logo-container">
        <h1>
          <a href="dashboard.html">
            <img src="static/LOGO 1.png" alt="BOOZY Logo" style="width:60px;height:60px;">
          </a>
          Gestionnaire
        </h1>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Rechercher...">
        <button>Recherche</button>
      </div>
      <div class="header-controls">
        <button onclick="switchLanguage()" class="lang-btn">üåê EN</button>
        <button class="logout" onclick="window.location.href='accueil.html'">D√©connexion</button>
      </div>
    </header>

    <div class="main">
      <nav id="sidebar">
        <a href="dashboard.html"><img src="static/Frame 218.png" alt="Accueil">Accueil</a>
        <a href="stores.html"><img src="static/store-alt.png" alt="Magasins">Magasins</a>
        <a href="orders.html"><img src="static/border-all.png" alt="Commandes">Commandes</a>
        <a href="products.html"><img src="static/wine-bottle.png" alt="Produits">Produits</a>
        <a href="users.html"><img src="static/users.png" alt="Utilisateurs">Utilisateurs</a>
      </nav>

      <section class="content">
        <div class="form-container">
          <h1>Cr√©er une commande</h1>
          <form id="form-commande">
            <label for="clientEmail">Courriel :</label>
            <input type="email" id="clientEmail" required>

            <label for="clientPassword">Mot de passe :</label>
            <input type="password" id="clientPassword" required>

            <label for="shopSelect">Magasin :</label>
            <select id="shopSelect" required>
              <option value="">Chargement‚Ä¶</option>
            </select>

            <div class="items-header">
              <span>Articles</span>
              <button type="button" id="addItemBtn">Ajouter un article</button>
            </div>
            <div id="itemsContainer">
              <!-- lignes dynamiques -->
            </div>

            <label for="payment_method">M√©thode de paiement :</label>
            <select id="payment_method" required>
              <option value="Visa">Visa</option>
              <option value="Mastercard">Mastercard</option>
              <option value="Interac">Interac</option>
            </select>

            <label for="card_name">Nom sur la carte :</label>
            <input type="text" id="card_name" required>

            <label for="card_number">Num√©ro de carte :</label>
            <input type="text" id="card_number" required>

            <label for="CVC_card">CVC :</label>
            <input type="text" id="CVC_card" required>

            <div style="display:flex; gap:8px;">
              <div style="flex:1;">
                <label for="expiry_month">Mois d‚Äôexpiration :</label>
                <input type="number" id="expiry_month" min="1" max="12" required>
              </div>
              <div style="flex:1;">
                <label for="expiry_year">Ann√©e d‚Äôexpiration :</label>
                <input type="number" id="expiry_year" min="2024" required>
              </div>
            </div>

            <button type="submit">Cr√©er la commande</button>
          </form>
          <p id="message" style="margin-top:12px;"></p>
        </div>
      </section>
    </div>

    <footer>
      <p><strong>¬©¬†2025¬†Boozy¬†Inc.</strong> Tous droits r√©serv√©s.</p>
      <p><a href="mailto:support@boozy.com">support@boozy.com</a>¬†|¬†514‚Äë652‚Äë3145</p>
    </footer>
  </div>

  <script>
    function switchLanguage() {
      window.location.href = "pageCommande_en.html";
    }
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("show");
      document.getElementById("overlay").classList.toggle("show");
    }

    // Charger les magasins
    async function loadShops() {
      const sel = document.getElementById("shopSelect");
      sel.innerHTML = '<option value="">S√©lectionnez‚Ä¶</option>';
      try {
        const res = await fetch("http://localhost:5000/getShops");
        const shops = await res.json();
        shops.forEach(s => {
          const o = document.createElement("option");
          o.value = s.shop_id;
          o.textContent = `${s.name} ‚Äî ${s.address}`;
          sel.appendChild(o);
        });
      } catch {
        sel.innerHTML = '<option value="">Erreur de chargement</option>';
      }
    }

    // Charger les produits disponibles pour un magasin
    async function loadProducts(shopId) {
      const rows = document.querySelectorAll(".item-row select");
      let avail = [];
      try {
        const res = await fetch(`http://localhost:5000/getAvailability?shop_id=${shopId}`);
        avail = await res.json();
      } catch {}
      rows.forEach(sel => {
        sel.innerHTML = '<option value="">Produit‚Ä¶</option>';
        avail.forEach(a => {
          const o = document.createElement("option");
          o.value = a.product_id;
          o.textContent = `${a.product.name} (${a.quantity} en stock)`;
          sel.appendChild(o);
        });
      });
    }

    // Ajouter une ligne article
    function addItemRow() {
      const cont = document.getElementById("itemsContainer");
      const div = document.createElement("div");
      div.className = "item-row";
      div.innerHTML = `
        <select required><option value="">Produit‚Ä¶</option></select>
        <input type="number" min="1" placeholder="Quantit√©" required>
        <button type="button" class="remove-btn">√ó</button>
      `;
      div.querySelector(".remove-btn").onclick = () => div.remove();
      cont.appendChild(div);
      const shopId = document.getElementById("shopSelect").value;
      if (shopId) loadProducts(shopId);
    }

    document.getElementById("addItemBtn").addEventListener("click", addItemRow);
    document.getElementById("shopSelect").addEventListener("change", e => loadProducts(e.target.value));

    // Soumettre le formulaire
    document.getElementById("form-commande").addEventListener("submit", async e => {
      e.preventDefault();
      const items = [];
      document.querySelectorAll(".item-row").forEach(row => {
        const pid = parseInt(row.querySelector("select").value,10);
        const qty = parseInt(row.querySelector("input").value,10);
        if (pid && qty>0) items.push({ product_id:pid, quantity:qty });
      });
      const body = {
        email: document.getElementById("clientEmail").value,
        password: document.getElementById("clientPassword").value,
        shop_id: parseInt(document.getElementById("shopSelect").value,10),
        items,
        payment_method: document.getElementById("payment_method").value,
        card_name: document.getElementById("card_name").value,
        card_number: document.getElementById("card_number").value,
        CVC_card: document.getElementById("CVC_card").value,
        expiry_date_month: document.getElementById("expiry_month").value,
        expiry_date_year: document.getElementById("expiry_year").value
      };
      try {
        const res = await fetch("http://localhost:5000/createOrder", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(body)
        });
        const result = await res.json();
        const msg = document.getElementById("message");
        if (result.status==="success") {
          msg.textContent = "Commande cr√©√©e avec succ√®s¬†!";
          msg.style.color = "green";
        } else {
          msg.textContent = "Erreur¬†: " + result.message;
          msg.style.color = "red";
        }
      } catch {
        const msg = document.getElementById("message");
        msg.textContent = "Erreur de connexion au serveur.";
        msg.style.color = "red";
      }
    });

    // Init
    window.addEventListener("DOMContentLoaded", () => {
      loadShops();
      addItemRow();
    });
  </script>
</body>
</html>
